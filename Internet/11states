TCP三次握手协议

首先是发送端先发送一个序列号SEQ，并发送一个SYN报文给服务器端 然后状态变为SYN_SENT

然后服务器收到了这个信息，返回一个SYN和一个ACK以及一个Seq  状态变为SYN_RECV

而发送端收到了服务器的确认信息后，返回一个ACK和一个序列号，然后状态变为 ESTABLISHED

服务器端收到这个ACK 状态也变为了ESTABLISHED

TCP四次分手协议

首先是主动关闭端发送一个FIN给另外一端 状态变为FIN_WAIT_1

然后另外一端收到后，返回一个ACK 状态变为CLOSE_WAIT

另外一端收到返回的ACK后，状态变为FIN_WAIT_2

当被动关闭的一方想要关闭的时候，发送一个FIN，然后进入状态LAST_ACK

主动关闭的一方接到对方的FIN，返回一个ACK，然后状态变为TIME_WAIT

到这里四次分手就结束了。

为什么只有握手要三次，两次不行么？ 因为如果服务器端返回的ack丢了，那么客户端就会再次发出请求，而服务端以为这是新的请求，就会建立新的连接，这样就平白无故的多出了许多连接，就会造成资源的浪费。这就是因为两次握手的话，服务器将不知道自己发送的这个数据是否丢了，默认算是连接上了。但是如果客户端没收到，就会重新发起连接，那么服务器就会形成两个连接，造成资源的浪费。

为什么需要四次挥手，因为这个连接是双工的，是两边都在互相传输，如果一端断开了连接，我们是认为单方面的终止数据的传输，而另一方是可以继续传输数据的，所以需要四次，因为两次分手确定一个连接断开。四次分手才能确认两个连接断开。

TIME_waited是为了什么？因为如果发送的ACK丢失了的话，对方就会继续发送FIN来终止连接，这样本端就会重新发送一个ACK来确保连接的断开。而且为了防止已经失效的请求报文出现在连接中，经过这个2MSL，产生的所有报文段都可以从网络中消失。

